<script type="text/html" id="Setup">
<%
	//测试数据
	if (location.href.indexOf('testdata')!=-1) {
		data.mode = data.mode || 'view';
		data.data = data.data || {};
		if (data.data) {
		data.data["Approvals"]  = {
				"CurrentWorkflow":{
					"handler":"李振文"
				}
				,"Done":[{
					"title":"之前的审批123",
					"key":"ApprovalTest123",
					"content":"我同意啊哈哈",
					"handler":"李振文",
					"time":1443670754853
				}]
				,"CurrentApproval":[{
					"title":"审批标题啊",
					"key":"ApprovalTest222"
				},{
					"title":"可以多个审批标题不",
					"key":"ApprovalTest333"
				}]
			};

			data.data["DisplayCharge"]  = true;
			data.data["Charge"]  = {"key":"value"};

			data.data["DisplayTracking"]  = true;
			data.data["Followup"]  = {"key":"value"};
			data.data['FollowupCanEdit'] = true;

			data.data["ChargeCanEdit"] = true;

			data.data["DisplayConfirm"]  = true;
			data.data["ConfirmCanEdit"]  = true;
		}
	}
%>

<%
	var RString = require('risk/unit/string');
	var DataView = data.data || {},
		Approvals = DataView.Approvals || {},	//审批信息
		Charge = DataView.Charge,	//财务信息
		Followup = DataView.Followup,	//保后跟踪
		CurrentActivity = DataView.CurrentActivity || [];

	//把业务类型放到一级，方便判断
	DataView.Type = DataView.Type || DataView.Project&&DataView.Project.Type || 1;

	var ShowApproval = !!(data.mode!=='add' && data.mode!=='edit'),	//审批
		ShowCharge = ShowApproval && DataView.DisplayCharge,	//收费情况
		ShowFollow = ShowApproval && DataView.DisplayTracking,	//保后
		ShowFinanceConfirm = DataView.DisplayConfirm;	//显示回款确认
		//  !!(ShowCharge && ShowFollow && (DataView.ChargeCanEdit || (DataView.DisplayCharge && DataView.Action==2)) );	//回款确认，“收费情况+保后”可见，且有编辑收费情况的权限时，才显示
%>

<div class="col-md-12 trade-detail">
	<%if (ShowApproval) {%>
		<%if (DataView.WorkflowComplete) { %>
			<div class="alert alert-success" role="alert"><i class="fa fa-check-circle"></i> 已确认回款，流程已结束</div>
		<%}else {%>
			<div class="alert alert-info" role="alert">当前流程到了<strong><%=CurrentActivity.Name%></strong>，审批人：<strong><%=DataView.Operator||'?'%></strong>，到达时间：<strong><%=RString.date(CurrentActivity.LastUpdateTime,"yyyy-MM-dd HH:mm:ss")%></strong></div>
		<%}%>
	<%}%>

	<form class="form-horizontal block-wizard" id="J_Wizzard" action="#">
		<ul class="wizard-steps">
			<%if (data.mode=='add') {%>
			<li data-hook="cancel" class="pointer-item">选择类型<span class="chevron"></span></li>
			<%}%>
			<li data-target="Customer" class="active">客户信息<span class="chevron"></span></li>
			<li data-target="Assets">房产信息<span class="chevron"></span></li>
			<li data-target="Guarantor">担保人<span class="chevron"></span></li>
			<li data-target="Project">项目信息<span class="chevron"></span></li>
			<li data-target="Report">调查报告<span class="chevron"></span></li>

			<%if (ShowApproval) {%>
				<li data-target="Approval">审批信息<span class="chevron"></span></li>
			<%}%>

			<%if (ShowCharge) {%>
			<li data-target="Charge">收费情况<span class="chevron"></span></li>
			<%}%>

			<%if (ShowFollow) {%>
			<li data-target="Followup">保后跟踪<span class="chevron"></span></li>
			<%}%>

			<%if (ShowFinanceConfirm) {%>
			<li data-target="FinanceConfirm">回款确认<span class="chevron"></span></li>
			<%}%>

		</ul>
		<div class="step-content">
			<%=this.SetupCustomer(data)%>
			<%=this.SetupProperty(data)%>
			<%=this.SetupGuarantor(data)%>
			<%=this.SetupProject(data)%>
			<%=this.SetupReport(data)%>

			<%if (ShowApproval) {%>
			<%=this.SetupApproval(data)%>
			<%}%>

			<%if (ShowCharge) {%>
			<%=this.SetupCharge(data)%>
			<%}%>

			<%if (ShowFollow) {%>
			<%=this.SetupFollowup(data)%>
			<%}%>

			<%if (ShowFinanceConfirm) {%>
			<%=this.SetupFinanceConfirm(data)%>
			<%}%>
		</div>
	</form>
</div>
</script>
